name: Docker Build CI

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'backend/**'
      - 'frontend/**'
      - 'docker-compose.yml'
      - '.github/workflows/ci-docker.yml'
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'backend/**'
      - 'frontend/**'
      - 'docker-compose.yml'
      - '.github/workflows/ci-docker.yml'

jobs:
  docker-build:
    name: Build Docker Images
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Create test .env file
        run: |
          cat > .env << EOF
          # CI Test Environment Variables
          DB_USER=test_user
          DB_PASSWORD=test_password
          DB_NAME=test_db
          GEMINI_API_KEY=dummy_key_for_build_test_only
          NODE_ENV=test
          EOF
          echo "Created .env file for CI build test"

      - name: Build backend image
        run: |
          docker build \
            --tag dnd-backend:ci-test \
            --file backend/Dockerfile \
            --build-arg NODE_ENV=test \
            backend/
          echo "Backend image built successfully"

      - name: Build frontend image
        run: |
          docker build \
            --tag dnd-frontend:ci-test \
            --file frontend/Dockerfile \
            --build-arg VITE_API_URL=http://localhost:3000 \
            --build-arg VITE_WS_URL=ws://localhost:3000 \
            frontend/
          echo "Frontend image built successfully"

      - name: Verify images were created
        run: |
          echo "Listing Docker images:"
          docker images | grep "dnd-" || {
            echo "Error: No dnd-* images found"
            exit 1
          }

          # Check image sizes
          echo ""
          echo "Image details:"
          docker images --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}" | grep "dnd-"

      - name: Build with docker-compose (smoke test)
        run: |
          docker-compose build --no-cache
          echo "Docker Compose build completed successfully"

  # NOTE: Skutečný health check test vyžaduje platný GEMINI_API_KEY
  # Pro kompletní integrační test by bylo potřeba:
  # 1. Přidat GEMINI_API_KEY do GitHub Secrets
  # 2. Odkomentovat následující job
  # 3. Spustit docker-compose up a čekat na healthy status

  # health-check:
  #   name: Health Check Integration Test
  #   runs-on: ubuntu-latest
  #   needs: docker-build
  #
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v5
  #
  #     - name: Create production-like .env
  #       run: |
  #         cat > .env << EOF
  #         DB_USER=test_user
  #         DB_PASSWORD=test_password
  #         DB_NAME=test_db
  #         GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
  #         NODE_ENV=test
  #         EOF
  #
  #     - name: Start services
  #       run: docker-compose up -d
  #
  #     - name: Wait for services to be healthy
  #       run: |
  #         echo "Waiting for database..."
  #         timeout 60 bash -c 'until docker-compose ps | grep database | grep healthy; do sleep 2; done'
  #
  #         echo "Waiting for backend..."
  #         timeout 60 bash -c 'until curl -f http://localhost:3000/health; do sleep 2; done'
  #
  #         echo "Waiting for frontend..."
  #         timeout 60 bash -c 'until curl -f http://localhost:5173; do sleep 2; done'
  #
  #     - name: Check service status
  #       run: docker-compose ps
  #
  #     - name: Show logs on failure
  #       if: failure()
  #       run: docker-compose logs
  #
  #     - name: Cleanup
  #       if: always()
  #       run: docker-compose down -v

  docker-security-scan:
    name: Security Scan (Trivy)
    runs-on: ubuntu-latest
    needs: docker-build

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Create test .env file
        run: |
          cat > .env << EOF
          DB_USER=test_user
          DB_PASSWORD=test_password
          DB_NAME=test_db
          GEMINI_API_KEY=dummy_key
          NODE_ENV=test
          EOF

      - name: Build images for scanning
        run: |
          docker build -t dnd-backend:scan backend/
          docker build -t dnd-frontend:scan frontend/

      - name: Run Trivy vulnerability scanner on backend
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'dnd-backend:scan'
          format: 'table'
          exit-code: '0'
          ignore-unfixed: true
          severity: 'CRITICAL,HIGH'

      - name: Run Trivy vulnerability scanner on frontend
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'dnd-frontend:scan'
          format: 'table'
          exit-code: '0'
          ignore-unfixed: true
          severity: 'CRITICAL,HIGH'
