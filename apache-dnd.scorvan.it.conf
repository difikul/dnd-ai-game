# ===============================================
# Apache VirtualHost Configuration for D&D AI Game
# ===============================================
# Tento soubor zkopírujte do: /etc/apache2/sites-available/subdomains/scorvan.it_dnd.conf
# Potom aktivujte: sudo a2ensite subdomains/scorvan.it_dnd.conf
# A restartujte Apache: sudo systemctl reload apache2

<VirtualHost *:80>
    ServerName dnd.scorvan.it
    ServerAdmin admin@scorvan.it

    # Redirect všeho HTTP na HTTPS
    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule ^ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

    ErrorLog ${APACHE_LOG_DIR}/dnd-error.log
    CustomLog ${APACHE_LOG_DIR}/dnd-access.log combined
</VirtualHost>

<VirtualHost *:443>
    ServerName dnd.scorvan.it
    ServerAdmin admin@scorvan.it

    # SSL Configuration
    SSLEngine on
    SSLCertificateFile /etc/ssl/certs/ssl.pem
    SSLCertificateKeyFile /etc/ssl/private/ssl.key

    # Modern SSL Configuration
    SSLProtocol all -SSLv3 -TLSv1 -TLSv1.1
    SSLCipherSuite ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384
    SSLHonorCipherOrder off
    SSLSessionTickets off

    # Security Headers
    Header always set Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "no-referrer-when-downgrade"

    # ===============================================
    # Backend API Proxy (Port 3100)
    # ===============================================
    <Location /api>
        ProxyPreserveHost On
        ProxyPass http://localhost:3100/api
        ProxyPassReverse http://localhost:3100/api

        # WebSocket support
        RewriteEngine On
        RewriteCond %{HTTP:Upgrade} =websocket [NC]
        RewriteRule /api/(.*) ws://localhost:3100/api/$1 [P,L]
        RewriteCond %{HTTP:Upgrade} !=websocket [NC]
        RewriteRule /api/(.*) http://localhost:3100/api/$1 [P,L]

        # Headers for proxying
        RequestHeader set X-Forwarded-Proto "https"
        RequestHeader set X-Forwarded-Port "443"
        RequestHeader set X-Forwarded-For "%{REMOTE_ADDR}s"
        RequestHeader set X-Real-IP "%{REMOTE_ADDR}s"
    </Location>

    # ===============================================
    # Health check endpoint (Backend)
    # ===============================================
    <Location /health>
        ProxyPreserveHost On
        ProxyPass http://localhost:3100/health
        ProxyPassReverse http://localhost:3100/health
    </Location>

    # ===============================================
    # Frontend Static Files Proxy (Port 8080)
    # ===============================================
    <Location />
        # Pokud není /api nebo /health, proxy na frontend
        ProxyPreserveHost On
        ProxyPass http://localhost:8080/
        ProxyPassReverse http://localhost:8080/

        # Headers pro SPA routing
        RequestHeader set X-Forwarded-Proto "https"
        RequestHeader set X-Forwarded-Port "443"
        RequestHeader set X-Forwarded-For "%{REMOTE_ADDR}s"
        RequestHeader set X-Real-IP "%{REMOTE_ADDR}s"
    </Location>

    # ===============================================
    # Static file caching (optimalizace)
    # ===============================================
    <LocationMatch "\.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$">
        # Cache static assets pro 1 rok
        Header set Cache-Control "public, max-age=31536000, immutable"

        ProxyPass http://localhost:8080/
        ProxyPassReverse http://localhost:8080/
    </LocationMatch>

    # Logging
    ErrorLog ${APACHE_LOG_DIR}/dnd-error.log
    CustomLog ${APACHE_LOG_DIR}/dnd-access.log combined

    # Detailed logging for debugging (můžete vypnout v produkci)
    LogLevel warn
    # Pro debugging změňte na: LogLevel proxy:trace5
</VirtualHost>

# ===============================================
# Poznámky k instalaci:
# ===============================================
# 1. Ujistěte se, že máte povolené potřebné Apache moduly:
#    sudo a2enmod proxy proxy_http proxy_wstunnel rewrite headers ssl
#
# 2. Zkopírujte tento soubor:
#    sudo cp apache-dnd.scorvan.it.conf /etc/apache2/sites-available/subdomains/scorvan.it_dnd.conf
#
# 3. Aktivujte site:
#    sudo a2ensite subdomains/scorvan.it_dnd.conf
#
# 4. Test konfigurace:
#    sudo apache2ctl configtest
#
# 5. Restart Apache:
#    sudo systemctl reload apache2
#
# 6. Ověřte, že Docker kontejnery běží:
#    docker ps | grep dnd
#    Měli byste vidět:
#    - dnd-frontend-prod na portu 8080
#    - dnd-backend-prod na portu 3100
#    - dnd-database-prod na portu 5433
