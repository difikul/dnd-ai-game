# ===============================================
# Apache VirtualHost Configuration for D&D AI Game
# ===============================================

<VirtualHost *:80>
    ServerName dnd.scorvan.it
    ServerAdmin admin@scorvan.it

    # DocumentRoot for ACME challenges
    DocumentRoot /www/hosting/vas-server.cz/acme

    # LetsEncrypt ACME challenge directory (must be accessible for SSL renewal)
    <Directory /www/hosting/vas-server.cz/acme/>
        Options -Indexes +FollowSymLinks
        AllowOverride None
        Require all granted
    </Directory>

    # Redirect v≈°eho HTTP na HTTPS (except ACME challenges)
    RewriteEngine On
    # Don't redirect ACME challenge requests - serve them directly
    RewriteCond %{REQUEST_URI} ^/\.well-known/acme-challenge/ [NC]
    RewriteRule ^ - [L]
    # Redirect everything else to HTTPS
    RewriteRule ^ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

    ErrorLog ${APACHE_LOG_DIR}/dnd-error.log
    CustomLog ${APACHE_LOG_DIR}/dnd-access.log combined
</VirtualHost>

<VirtualHost *:443>
    ServerName dnd.scorvan.it
    ServerAdmin admin@scorvan.it

    # SSL Configuration - Wildcard LetsEncrypt Certificate
    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/scorvan.it/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/scorvan.it/privkey.pem

    # Modern SSL Configuration
    SSLProtocol all -SSLv3 -TLSv1 -TLSv1.1
    SSLCipherSuite ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384
    SSLHonorCipherOrder off
    SSLSessionTickets off

    # LetsEncrypt ACME challenge directory (for SSL renewal)
    Alias /.well-known/acme-challenge/ /www/hosting/vas-server.cz/acme/.well-known/acme-challenge/
    <Directory /www/hosting/vas-server.cz/acme/.well-known/acme-challenge/>
        Options None
        AllowOverride None
        Require all granted
    </Directory>

    # CRITICAL FIX: Disable global ErrorDocument rewrites
    ProxyErrorOverride Off

    # Proxy settings
    ProxyPreserveHost On
    ProxyRequests Off

    # Security Headers
    Header always set Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "no-referrer-when-downgrade"

    # ===============================================
    # Reverse Proxy Configuration
    # ORDER IS CRITICAL: Most specific paths first!
    # ===============================================

    # 1. Backend API (port 3100)
    ProxyPass /api http://localhost:3100/api nocanon
    ProxyPassReverse /api http://localhost:3100/api

    # 2. Health check endpoint
    ProxyPass /health http://localhost:3100/health
    ProxyPassReverse /health http://localhost:3100/health

    # 3. Everything else to frontend (port 8080) - MUST BE LAST
    ProxyPass / http://localhost:8080/
    ProxyPassReverse / http://localhost:8080/

    # Logging
    ErrorLog ${APACHE_LOG_DIR}/dnd-error.log
    CustomLog ${APACHE_LOG_DIR}/dnd-access.log combined
    LogLevel warn
</VirtualHost>
