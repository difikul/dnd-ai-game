generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              String        @id @default(uuid())
  email           String        @unique
  username        String        @unique
  passwordHash    String
  role            String        @default("user") // "user" or "admin"
  geminiApiKey    String?       @db.Text  // Encrypted Gemini API token

  // Relations
  characters      Character[]
  gameSessions    GameSession[]

  // Meta
  isActive        Boolean       @default(true)
  lastLoginAt     DateTime?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([email])
  @@index([username])
}

model Character {
  id        String   @id @default(uuid())
  name      String
  race      String
  class     String
  level     Int      @default(1)

  // Stats
  strength      Int
  dexterity     Int
  constitution  Int
  intelligence  Int
  wisdom        Int
  charisma      Int

  // Combat
  hitPoints       Int
  maxHitPoints    Int
  armorClass      Int

  // Meta
  experience      Int      @default(0)
  avatarUrl       String?
  background      String?  @db.Text

  // User ownership
  userId        String
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Relations
  gameSessions GameSession[]
  inventory    Item[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([name])
  @@index([userId])
}

model GameSession {
  id              String   @id @default(uuid())
  sessionToken    String   @unique // Pro sdílení

  // User ownership
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  characterId     String
  character       Character @relation(fields: [characterId], references: [id], onDelete: Cascade)

  // Game State
  currentLocation String
  questLog        Json     @default("[]") // Array of quests
  worldState      Json     @default("{}") // Custom world variables

  // Conversation History
  messages        Message[]

  // Meta
  isActive        Boolean  @default(true)
  lastPlayedAt    DateTime @default(now())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([sessionToken])
  @@index([characterId])
  @@index([userId])
  @@index([lastPlayedAt])
}

model Message {
  id            String   @id @default(uuid())

  sessionId     String
  session       GameSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  role          String   // "player", "narrator", "system"
  content       String   @db.Text
  metadata      Json?    // Dice rolls, combat results, etc.

  createdAt     DateTime @default(now())

  @@index([sessionId])
  @@index([createdAt])
}

model Item {
  id          String   @id @default(uuid())

  characterId String
  character   Character @relation(fields: [characterId], references: [id], onDelete: Cascade)

  name        String
  type        String   // weapon, armor, potion, misc
  description String?  @db.Text
  quantity    Int      @default(1)
  equipped    Boolean  @default(false)

  // Stats for weapons/armor
  damage      String?  // "1d8+2"
  armorValue  Int?
  properties  Json?    // Special properties

  createdAt   DateTime @default(now())

  @@index([characterId])
  @@index([equipped])
}

model WorldLocation {
  id          String   @id @default(uuid())
  name        String   @unique
  description String   @db.Text
  type        String   // town, dungeon, wilderness, cave, castle, etc.
  imageUrl    String?

  // Connections
  connectedTo Json     @default("[]") // Array of location IDs

  // NPCs and Encounters
  npcs        Json?
  encounters  Json?

  // Discovery
  discovered  Boolean  @default(false)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([name])
  @@index([type])
}
